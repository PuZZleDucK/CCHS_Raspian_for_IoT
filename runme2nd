#!/usr/bin/env bash
# Copyright (c) 2013 All Right Reserved  Alec Clews
#
# author: Alec Clews
# alecclews@gmail.com
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
#
#    Special thanks to @mikered for wifi set up code

echo
echo About to fully upgrade all relevent packges and optionally install ROS
echo This will take some time
echo

export UPDATE_LABEL="Updated_$(date +%F)"

# Make sure system is fully up to date
sudo apt-get -y dist-upgrade  # Important. Must be using new firmware before we do rest

ask() {
  read -p "$1" -r < /dev/tty
  echo $REPLY
}

calc_wt_size() {
  # NOTE: it's tempting to redirect stderr to /dev/null, so supress error
  # output from tput. However in this case, tput detects neither stdout or
  # stderr is a tty and so only gives default 80, 24 values
  WT_HEIGHT=17
  WT_WIDTH=$(tput cols)

  if [ -z "$WT_WIDTH" ] || [ "$WT_WIDTH" -lt 60 ]; then
    WT_WIDTH=80
  fi
  if [ "$WT_WIDTH" -gt 178 ]; then
    WT_WIDTH=120
  fi
  WT_MENU_HEIGHT=$(($WT_HEIGHT-8))
}

calc_wt_size


do_wifi() {
# Written by @mikerr and stolen by @alecthegeek, see https://github.com/mikerr/raspi-config

wifidevice=wlan0
WPAFILE=/etc/wpa_supplicant/wpa_supplicant.conf

{
iwlist $wifidevice scan | grep 'ESSID' | sed -e 's/.*ESSID:"\([^"]\+\)".*/  \1/' > /tmp/ap_list.txt 
} | whiptail --gauge "Scanning Wifi, please wait" 5 50 10

echo "whiptail --title \"Choose SSID, or enter manually\" \\" > /tmp/choose_ap.sh
echo "--radiolist \"Choose SSID\" \\" >> /tmp/choose_ap.sh

LINES=`wc -l < /tmp/ap_list.txt`
LINES=$((${LINES}+1))
echo "10 60 ${LINES} \\" >> /tmp/choose_ap.sh
for LINE in `cat /tmp/ap_list.txt`
    do
    echo "$LINE '' off \\" >> /tmp/choose_ap.sh
    done
echo "Enter\ manually '' on 2>/tmp/ssid.ans" >>/tmp/choose_ap.sh
    
chmod 777 /tmp/choose_ap.sh
. /tmp/choose_ap.sh
      
if [ $? -ne 0 ]; then return 0; fi

SSID=`cat /tmp/ssid.ans`
if [ "$SSID" = "Enter manually" ]; then
      SSID=$(whiptail --inputbox "SSID Name" 20 70 3>&1 1>&2 2>&3)
    if [ -z $SSID ]; then return 0 ; fi
fi

ENCRYPTION=$(whiptail --title "Encryption" --menu "Encryption for network: $SSID " $WT_HEIGHT $WT_WIDTH $WT_MENU_HEIGHT --cancel-button Back --ok-button Select \
          "1" "WPA/WPA2" \
          "2" "WEP (hex)" \
          "3" "WEP (ascii)" \
          "4" "None" \
        3>&1 1>&2 2>&3)

if [ $? -ne 0 ]; then return 0; fi

WPANEW=/tmp/wpanew.conf
WPATMP=/tmp/wpa.conf

case $ENCRYPTION in
    '1')
        PASSPHRASE=$(whiptail --inputbox "WPA Passphrase for $SSID" 20 70 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then return 0; fi
       CRYPTPASS=$(wpa_passphrase $SSID $PASSPHRASE | grep -v "^#" | grep -v "#psk=")
      PASSERROR="Passphrase must be 8..63 characters"
        if [ "$CRYPTPASS" != "$PASSERROR" ]; then 
        echo "$CRYPTPASS" > $WPANEW
      else
        whiptail --msgbox "ERROR: $PASSERROR" 20 70 1
        return 0;
      fi
    ;;
    '2')
        PASSPHRASE=$(whiptail --inputbox "WEP key (Hex)" 20 70 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then return 0; fi

                  echo "network={
                           ssid=\"$SSID\"
                          key_mgmt=NONE
                            wep_key0=$PASSPHRASE
                            }" > $WPANEW
    ;;
    '3')
        PASSPHRASE=$(whiptail --inputbox "WEP key (ascii)" 20 70 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then return 0; fi

       echo "network={
                   ssid=\"$SSID\"
                   key_mgmt=NONE
                   wep_key0=\"$PASSPHRASE\"
                   }" > $WPANEW
    ;;
    '4')
      echo "network={
                   ssid=\"$SSID\"
                   key_mgmt=NONE
                   }" > $WPANEW
    ;;
esac
# Remove previous matching SSID config first
sudo cat $WPAFILE | perl -00 -pe "s/network=\{[^}]*ssid=\"$SSID\"*[^}]*\}//g" > $WPATMP
# append /merge new config at end of config file
cat $WPATMP $WPANEW | sudo tee  $WPAFILE

whiptail --msgbox "Wifi settings updated for SSID: $SSID" 20 60 1

# connect right now ?
#wpa_supplicant -B -i$wifidevice -c $WPAFILE
#dhclient $wifidevice -1 

}


setConfigOption() {
  CONFIG_FILE=/boot/config.txt
  if grep "$1=" $CONFIG_FILE ; then
    sudo sed --in-place -re "s/^#?$1=.+$/$1=$2 #$UPDATE_LABEL/" $CONFIG_FILE
  else
    echo $1=$2'  #'$UPDATE_LABEL| sudo tee -a $CONFIG_FILE
  fi
}

export -f setConfigOption 

setOverclock() {

  clockSettings=("None ARM:700MHz core:250MHz SDRAM:400MHz overvolt:0"\
                 "Modest ARM:800MHz core:250MHz SDRAM:400MHz overvolt:0"\
                 "Medium ARM:900MHz core:250MHz SDRAM:450MHz overvolt:2"\
                 "High ARM:950MHz core:250MHz SDRAM:450MHz overvolt:6"\
                 "Turbo ARM:1000MHz core:500MHz SDRAM:600MHz overvolt:6")

  echo "Please select your clock settings from the following list. NB Turbo is NOT recommended"

  select c in "${clockSettings[@]}"; do
    echo "$c" | 
    sed -re 's/^[A-Za-z]+ ARM:([0-9]+)MHz core:([0-9]+)MHz SDRAM:([0-9]+)MHz overvolt:([0-9]+)$/arm_freq \1 core_freq \2 sdram_freq \3 over_voltage \4/' |
    xargs --no-run-if-empty -n 2 bash -c 'setConfigOption "$@"' {}
    break
  done < /dev/tty

}

splitMemory() {
  REPLY=0
  while [[ ! $REPLY =~ (16|32|64|128|256) ]] ; do
    read -p  "How much video memory do you want? (16|32|64|128|256) " -r < /dev/tty
  done

  setConfigOption gpu_mem $REPLY
}




# Install and enable i2c and SPI
sudo apt-get -y install i2c-tools lm-sensors
sudo sed /etc/modprobe.d/raspi-blacklist.conf \
  -i -e 's/^#blacklist spi-bcm2708/blacklist spi-bcm2708/' \
  -e 's/^#blacklist i2c-bcm2708/blacklist i2c-bcm2708/'
  
sudo adduser $USER i2c

echo Installed support for I2C serial interface and LM sensors
echo added $USER to the i2c group
echo

# Install a few dev tools
sudo apt-get -y install vim git git-gui git-doc git-svn subversion screen tmux ack-grep emacs

# Install the WiringPi

WP=/usr/src/wiringPi

sudo mkdir -p $WP
sudo chown $USER:$(id -g -n $USER) $WP

cd $WP

git clone git://git.drogon.net/wiringPi .
./build

cat <<EOF |sudo tee /usr/local/bin/updateWiringPi
#!/usr/bin/env sh
# Keep wiringPi updated

cd $WP
git pull origin &&
./build &&
echo WiringPi updated ||
echo WiringPi update failed
EOF

sudo chmod + /usr/local/bin/updateWiringPi

echo "To update the wiringPi library run the script /usr/local/bin/updateWiringPi as needed"
echo


if [[ $(ask "Do you wish to install the Robot OS? (http://ros.org)[y/N] ") =~ ^[Yy]$ ]]
then

  sudo apt-get -y install ros-groovy-ros-comm \
    ros-groovy-rqt-gui ros-groovy-rqt-common-plugins \
    ros-groovy-roscpp-tutorials ros-groovy-turtlesim \
    ros-groovy-rosserial-arduino 

  echo '# Setup for ROS ' >> ~/.bashrc
  echo source /opt/ros/groovy/setup.bash >> ~/.bashrc
else
  echo
fi


echo Processing
sudo dpkg-reconfigure locales
sudo dpkg-reconfigure tzdata
echo Processing
sudo dpkg-reconfigure keyboard-configuration
sudo invoke-rc.d keyboard-setup start
splitMemory
setOverclock

if [[ $(ask "Do you wish to support WiFI? [y/N] ") =~ ^[Yy]$ ]]
then

  sudo apt-get install -y wpasupplicant

  do_wifi

  sudo ifdown wlan0
  sudo ifup wlan0
else
  echo
fi

if [[ $(ask "Do you wish to support Zero Conf Bonjour? [y/N] ") =~ ^[Yy]$ ]]
then
  sudo apt-get install -y avahi-daemon avahi-utils
  echo If all has gone well you will be able to access this device using ssh $USER@$(hostname -s).local
else
  echo
fi

read -p  "Do you wish to install a JDK?" -n 1 -r  < /dev/tty
echo

if [[ $REPLY =~ ^[Yy]$ ]]
then

  select n in "OpenJDK" "Oracle Java 8 beta" "Finished"; do
    case $REPLY in 

      "1" )
        sudo apt-get -y install openjdk-7-jdk openjdk-7-doc
        ;;

      "2" ) 

        echo "Note that by installing the Oracle JDK you are agreeing to Early Adopter Development License Agreement for Java SE"
        echo "You can read the agreement at http://www.oracle.com/technetwork/licenses/ea-license-152003.html"
        read -p "Do you accept the license? [y/N] " -n 1 -r < /dev/tty

        [[ $REPLY =~ ^[Yy]$ ]] || break

        wget --no-check-certificate $(wget --no-check-certificate https://jdk8.java.net/download.html -O - 2>/dev/null | sed -ne 's/^..*"linARMhfJDK"..*"\(http:\/\/..*\)".*$/\1/p')

        tar xzf jdk-8*.tar.gz

        test  -d /opt/jdk1.8.0/ && sudo rm -rf /opt/jdk1.8.0/
        sudo mv ./jdk1.8.0/ /opt/
        sudo chown root:root -R /opt/jdk1.8.0/
        sudo ln -s /opt/jdk1.8.0/ /opt/jdk8
        rm  jdk-8*.tar.gz

        echo '# Setup for Java 8' >> ~/.bashrc
        echo PATH='$PATH':/opt/jdk8/bin  >> ~/.bashrc
        echo JAVA_HOME=/opt/jdk8  >> ~/.bashrc
        ;;

      "3" ) break;; 

    esac
  done  < /dev/tty
fi


read -p  "Do you wish to install the Arduino IDE (NB Will install OpenJDK if needed) ? " -n 1 -r  < /dev/tty
echo

if [[ $REPLY =~ ^[Yy]$ ]] ; then
        sudo apt-get -y install openjdk-7-jdk arduino arduino-mk libdevice-serialport-perl
fi

read -p  "Do you wish to install the NodBots (NB Will install Arduino and OpenJDK if needed) ? " -n 1 -r  < /dev/tty
echo

if [[ $REPLY =~ ^[Yy]$ ]] ; then
        sudo apt-get -y install openjdk-7-jdk
        sudo apt-get -y install nodejs npm minicom arduino arduino-mk libdevice-serialport-perl
        sudo npm install compulsive serialport johnny-five
fi

# Remove anything out of date
sudo apt-get autoremove
# Save a few hundred Mb of disk space by removing downloaded deb archives
sudo apt-get clean

[[ -e /etc/profile.d/raspi-config.sh ]] && rm -f /etc/profile.d/raspi-config.sh

echo Please use sudo raspi-config to configure additional options and use sudo apt-get dist-upgrade on a regular basis

read -p "System will now reboot. Press any key to continue " -n 1 -r < /dev/tty

sudo shutdown -rF now # Force disk check
