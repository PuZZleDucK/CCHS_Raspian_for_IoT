#!/usr/bin/env bash
# Copyright (c) 2013 All Right Reserved  Alec Clews
#
# author: Alec Clews
# alecclews@gmail.com
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
#
# Run this script on a new install of Raspberry Pi Raspian

# Add repo for Robot operating System
sudo sh -c 'echo \
"deb http://64.91.227.57/repos/rospbian wheezy main" > \
/etc/apt/sources.list.d/rospbian.list'
wget http://64.91.227.57/repos/rospbian.key -O - | sudo apt-key add -

# Get updated package list
sudo apt-get update

# Make sure we using the lastest veriosn of config script
sudo apt-get install -y raspi-config

oldhostname=$(cat /etc/hostname)
echo
echo It is highly recommended that the hostname is changed to something unique on the network.
echo Later you will have the option to install Zero conf which requires ALL machines to have
echo a unique name. If you can\'t think of anything I suggest something like \<yourName\>pi\<n\> where
echo n is some single digit number. The current hostname is \"$oldhosname\"
echo

read -p  "Do you wish to change the hostname?[y/N] " -n 1 -r < /dev/tty
echo

if [[ $REPLY =~ ^[Yy]$ ]]
then

  read -p  "Please enter the hostname (letters and numbers only) " -r < /dev/tty

  echo $REPLY | sudo tee /etc/hostname > /dev/null

  sudo sed -ie 's/^\(..*\)'$oldhostname'\(.*\)$/\1'$REPLY'\2/' /etc/hosts

fi

# Rename the pi user accountA
echo
echo "You will now be offered to the chance to change the user name of the current user account"
echo "from $USER to something of your own choosing"
echo
echo "N.B. If this process fails you will probablu have to re-image your SD card"A
echo

read -p  "Do you wish to rename the $USER user account?[y/N] " -n 1 -r < /dev/tty
echo

if [[ $REPLY =~ ^[Yy]$ ]]
then

    read -p  "Please enter the new user name " -r < /dev/tty

cat <<'EOF' | sudo bash -s $USER $REPLY $HOME
     for i in /etc/group /etc/passwd /etc/sudoers /etc/shadow ; do 
          sed -rie '/\b'$1'\b/s/\b'$1'\b/'$2'/g' $i
     done
     mv $3 /home/$2
EOF

    echo "User name changed to $USER"

fi

#Expand the rootfs and reboot
sudo raspi-config --expand-rootfs
sudo init 6
